[[release-notes-4.x]]
=== Node.js Agent version 1.x

==== Unreleased

See the <<upgrade-to-v4>> guide.

[float]
===== Breaking changes

* Set the new minimum supported Node.js to version 14.5.0.
  Users of earlier Node.js versions can use elastic-apm-node v3.x, which
  supports back to Node.js v8.6.

* Ignore a `timer` option passed to `startTransaction()` and `startSpan()` APIs.
  This option was never documented. It would be surprising if any user is
  impacted by this.

* Remove long deprecated support for the `ELASTIC_APM_`-prefixed environment
  variables for the <<kubernetes-node-name,Kubernetes config options>>. For
  example, one must use `KUBERNETES_POD_NAME` and not
  `ELASTIC_APM_KUBERNETES_POD_NAME`. ({issues}2661[#2661])

* The config option `filterHttpHeaders` is now *removed*. ({pull}3539[#3539])

* Remove the deprecated `span.toString()` and `transaction.toString()` APIs.
  See <<v4-api-to-string,the upgrading doc>> for details. ({issues}2348[#2348])

* Remove instrumentation support for the old 'hapi' package -- the current
  '@hapi/hapi' package is still instrumented. ({issues}2691[#2691])

* Change `apm.startTransaction()` api to return a noop transaction instead of
  null. ({issues}2429[#2429])

* Drop support for the obsolete "patch" context manager, i.e. the
  `contextManager: "patch"` config option. This was a limited async context
  management that predated the preferred `AsyncLocalStorage` core Node.js
  mechanism for context tracking. It was deprecated in v3.37.0.  As well, the
  related and deprecated `asyncHooks` config option has been removed.
  ({issues}3529[#3529])

[float]
===== Features

* The `apm.destroy()` method is now async. Almost no users should need to use
  this method. However, if used, to be sure to wait for APM agent shutdown to
  be complete, one can now `await apm.destroy()`. ({issues}3222[#3222])


[float]
===== Bug fixes

[float]
===== Chores

* Add a warning message when a duration or size config option is provided
  without units. ({issues}2121[#2121])

* Change default value of `useElasticTraceparentHeader` config option to `false`.
  This means that for outgoing HTTP requests, the APM agent will no longer add the
  `elastic-apm-traceparent` header. This vendor-specific header was used in the past
  while the https://w3c.github.io/trace-context/[W3C trace-context] spec was still
  in development. Now that it is in wide use, the `elastic-apm-traceparent` header is
  only useful for interaction with very old Elastic APM agents.

[[release-notes-3.x]]
=== Node.js Agent version 3.x

XXX This CHANGELOG4 file will be merged into CHANGELOG.asciidoc before merging to main.

