name: TAV

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
    - '**/*.md'
    - '**/*.asciidoc'
    - 'docs/**'
    - 'examples/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# limit the access of the generated GITHUB_TOKEN
permissions:
  contents: read

jobs:
  test-tav:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      max-parallel: 30
      fail-fast: false
      matrix:
        # A job matrix limit is 256. Grouping below is to stay under that limit.
        # https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration
        node:
          - "19"
          - "18"
          - "16"
          - "14"
          - "12"
          - "10"
          - "8"
        module:
          - '@elastic/elasticsearch'
          - '@elastic/elasticsearch-canary'
          - '@hapi/hapi'
          - '@opentelemetry/api'
          - '@opentelemetry/sdk-metrics'
          - apollo-server-express
          - aws-sdk
          - cassandra-driver
          - elasticsearch
          - express
          - express-graphql
          - express-queue
          - fastify
          - finalhandler
          - generic-pool
          - graphql
          - ioredis
          - knex
          - memcached
          - mongodb
          - mongodb-core
          - mysql
          - mysql2
          - next
          - pg
          - redis
          - restify
          - tedious
          - undici
          - ws
          # Grouped sets.
          - '@koa/router,koa-router'
          - handlebars,pug
          - bluebird,got,mimic-response
    steps:
      - uses: actions/checkout@v3
      - run: .ci/scripts/test.sh -b "release" -t "${{ matrix.module }}" "${{ matrix.node }}"
        env:
          ELASTIC_APM_CONTEXT_MANAGER: ''
